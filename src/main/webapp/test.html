<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.9.0/vis.min.css" rel="stylesheet"></style>
  <style>
    html, body, #structureView
    {
      width: 100%;
      height: 100%;
    }

    #structureView
    {
      background-image: url("assets/img/img-bg-1.jpg");
    }
  </style>
</head>
<body>
<div id="structureView"></div>
<a style="position:absolute;top: 20px; left: 50px;color:white" href="#" onclick="showProgressEvent()">showprogress</a>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.9.0/vis.min.js"></script>

<script>
  var background = document.createElement('img');
  background.src = "assets/img/img-bg-1.jpg";

  var showProgress = false;

  // create an array with nodes
  var nodes = new vis.DataSet([
    {id: 1, label: 'Node 1', image: "assets/img/img-foundation-sphere.png", data: {a: "a"}},
    {id: 2, label: 'Node 2', image: "assets/img/img-foundation-sphere.png", data: {a: "b"}},
    {id: 3, label: 'Node 3', image: "assets/img/img-foundation-sphere.png", data: {a: "c"}},
    {id: 4, label: 'Node 4', image: "assets/img/img-foundation-sphere.png", data: {a: "d"}},
    {
      id: 5, label: 'Node 5', image: "assets/img/img-foundation-sphere.png", data: {a: "e"},
      shadow: {
        enabled: false,
        size: 10,
        x: 5,
        y: 5
      },

      shapeProperties: {
        borderDashes: false, // only for borders
        borderRadius: 1,     // only for box shape
        useImageSize: false,  // only for image and circularImage shapes
        useBorderWithImage: false
      }
    }
  ]);

  // create an array with edges
  var edges = new vis.DataSet([
    {from: 1, to: 3},
    {from: 1, to: 2},
    {from: 2, to: 4},
    {from: 2, to: 5}
  ]);

  // create a network
  var container = document.getElementById('structureView');

  // provide the data in the vis format
  var data = {
    nodes: nodes,
    edges: edges
  };

  var options = {
    autoResize: true,
    height: '100%',
    width: '100%',
    locale: 'en',
    clickToUse: false,
    nodes: {
      size: 30,
      shape: 'image',
      font: {
        size: 32,
        color: '#ffffff'
      }
    },
    edges: {
      dashes: true
    }
  };

  var selectedNode = null;

  // initialize your network!
  var network = new vis.Network(container, data, options);
  console.log(network.getViewPosition());
  network.on("click", function (e) {
    selectedNode = e.nodes[0];
  });
  network.body.view.scale = 1;
  network.physics.gravitySolver.options.gravitationalConstant = -50000;
  network.physics.options.minVelocit = 10;
  network.physics.gravitySolver.options.cetralGravity = 0;

  network.on("doubleClick", function (e) {
    var ids = nodes.getIds();

    selectedNode = e.nodes[0];

    for (var i = 0; i < ids.length; i++) {
      if (selectedNode != ids[i]) {
        nodes.remove(ids[i]);
      }
    }

    edges.clear();

    for (var i = 10; i < 14; i++) {
      nodes.add({id: i, label: 'Node ' + i, image: "assets/img/img-design-sphere.png", data: {a: "a"}});
      edges.add({from: selectedNode, to: i});
    }

    edges.add({from: 10, to: 14, label: "blocker", color: "red"});
  });

  network.on("initRedraw", function () {
    // do something like move some custom elements?
  });
  network.on("beforeDrawing", function (ctx) {
    var size = 50;

    var objIds = nodes.getIds();

    var nodePosition = network.getPositions(objIds);

    if (nodePosition == undefined || nodePosition == null)
      return;

    for (var i = 0; i < objIds.length; i++) {
      drawMetrics(ctx, nodePosition[objIds[i]], size);
    }


    nodePosition = network.getPositions(selectedNode)[selectedNode];

    if (nodePosition == undefined || nodePosition == null)
      return;

    highlightNode(ctx, nodePosition, size);
  });
  network.on("afterDrawing", function (ctx) {

  });

  function highlightNode(ctx, nodePosition, size) {
    ctx.save();
    ctx.shadowColor = "#888";
    ctx.shadowBlur = 20;
    ctx.beginPath();

    ctx.strokeStyle = "#FFF";
    ctx.lineWidth = 2;

    ctx.arc(nodePosition.x, nodePosition.y, size, 0, Math.PI * 2, true);
    ctx.stroke();
    ctx.closePath();

    ctx.restore();
  }

  function drawMetrics(ctx, nodePosition, size) {
    console.log(network.canvas.body.view.translation.x / 2, network.canvas.body.view.translation.y / 2);

    ctx.beginPath();
    ctx.arc(network.getViewPosition().x / 2, network.getViewPosition().y / 2, 20, 0, 2 * Math.PI);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(nodePosition.x - 50 * Math.cos(Math.atan2(network.getViewPosition().y / 2 - nodePosition.y, network.getViewPosition().x / 2 - nodePosition.x)), nodePosition.y - 50 * Math.sin(Math.atan2(network.canvas.body.view.translation.y / 2 - nodePosition.y, network.canvas.body.view.translation.x / 2 - nodePosition.x)), 30, 0, 2 * Math.PI);
    ctx.stroke();
    ctx.lineWidth = 5;
    if (showProgress) {
      ctx.save();


      ctx.beginPath();
      ctx.strokeStyle = "#009933";
      ctx.arc(nodePosition.x, nodePosition.y, size - 15, 0, -Math.PI * 2 * 0.2, true);
      ctx.stroke();
      ctx.closePath();

      ctx.beginPath();
      ctx.strokeStyle = "#FFCC00";
      ctx.arc(nodePosition.x, nodePosition.y, size - 15, -Math.PI * 2 * 0.2, -Math.PI * 2 * 0.7, true);
      ctx.stroke();
      ctx.closePath();

      ctx.beginPath();
      ctx.strokeStyle = "#3399FF";
      ctx.arc(nodePosition.x, nodePosition.y, size - 15, -Math.PI * 2 * 0.7, -Math.PI * 2, true);
      ctx.stroke();
      ctx.closePath();


      ctx.font = "15px serif";
      ctx.fillStyle = "#FFF";
      ctx.fillText("Devs 24", nodePosition.x - size - 10, nodePosition.y - size + 15);

      ctx.restore();
    }
  }

  function showProgressEvent() {
    showProgress = !showProgress;
    network.redraw();
  }
</script>
</body>
</html>